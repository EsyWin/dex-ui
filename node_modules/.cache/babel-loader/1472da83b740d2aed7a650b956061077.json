{"ast":null,"code":"var _jsxFileName = \"/home/dev/Code/dex-ui/src/components/ConvertForm.tsx\";\nimport React, { useEffect, useState } from 'react';\nimport { Button, Col, Input, Row, Select, Typography } from 'antd';\nimport styled from 'styled-components';\nimport { Orderbook } from '@project-serum/serum';\nimport { getExpectedFillPrice, getMarketDetails, getMarketInfos, getMarketOrderPrice, getSelectedTokenAccountForMint, MarketProvider, useBalances, useCustomMarkets, useLocallyStoredFeeDiscountKey, useMarket, useTokenAccounts } from '../utils/markets';\nimport { notify } from '../utils/notifications';\nimport { useWallet } from '../utils/wallet';\nimport { useConnection, useSendConnection } from '../utils/connection';\nimport { placeOrder } from '../utils/send';\nimport { floorToDecimal, getDecimalCount } from '../utils/utils';\nimport FloatingElement from './layout/FloatingElement';\nimport WalletConnect from './WalletConnect';\nimport { SwapOutlined } from '@ant-design/icons';\nconst {\n  Option\n} = Select;\nconst {\n  Title\n} = Typography;\nconst ActionButton = styled(Button)`\n  color: #2abdd2;\n  background-color: #212734;\n  border-width: 0px;\n`;\nconst ConvertButton = styled(Button)`\n  background: #02bf76;\n  border-color: #02bf76;\n`;\nexport default function ConvertForm() {\n  const {\n    connected,\n    wallet\n  } = useWallet();\n  const {\n    customMarkets\n  } = useCustomMarkets();\n  const marketInfos = getMarketInfos(customMarkets);\n  const [marketAddress, setMarketAddress] = useState(null);\n  const [fromToken, setFromToken] = useState(undefined);\n  const [toToken, setToToken] = useState(undefined);\n  const [size, setSize] = useState(undefined);\n  const marketInfosbyName = Object.fromEntries(marketInfos.map(market => [market.name, market]));\n  const tokenConvertMap = new Map();\n  Object.keys(marketInfosbyName).forEach(market => {\n    let [base, quote] = market.split('/');\n    !tokenConvertMap.has(base) ? tokenConvertMap.set(base, new Set([quote])) : tokenConvertMap.set(base, new Set([...(tokenConvertMap.get(base) || []), quote]));\n    !tokenConvertMap.has(quote) ? tokenConvertMap.set(quote, new Set([base])) : tokenConvertMap.set(quote, new Set([...(tokenConvertMap.get(quote) || []), base]));\n  });\n\n  const setMarket = toToken => {\n    const marketInfo = marketInfos.filter(marketInfo => !marketInfo.deprecated).find(marketInfo => marketInfo.name === `${fromToken}/${toToken}` || marketInfo.name === `${toToken}/${fromToken}`);\n\n    if (!marketInfo) {\n      console.warn(`Could not find market info for market names ${fromToken}/${toToken} or ${toToken}/${fromToken}`);\n      notify({\n        message: 'Invalid market',\n        type: 'error'\n      });\n      return;\n    }\n\n    setMarketAddress(marketInfo.address.toBase58());\n    setToToken(toToken);\n  };\n\n  return /*#__PURE__*/React.createElement(FloatingElement, {\n    style: {\n      maxWidth: 500\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 97,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Title, {\n    level: 3,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 98,\n      columnNumber: 7\n    }\n  }, \"Convert\"), !connected && /*#__PURE__*/React.createElement(Row, {\n    justify: \"center\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 100,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Col, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 101,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(WalletConnect, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 102,\n      columnNumber: 13\n    }\n  }))), tokenConvertMap && connected && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Row, {\n    style: {\n      marginBottom: 8\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 108,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Col, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 109,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Select, {\n    style: {\n      minWidth: 300\n    },\n    placeholder: \"Select a token\",\n    value: fromToken,\n    onChange: token => {\n      setFromToken(token);\n      setToToken(undefined);\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 110,\n      columnNumber: 15\n    }\n  }, Array.from(tokenConvertMap.keys()).map(token => /*#__PURE__*/React.createElement(Option, {\n    value: token,\n    key: token,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 120,\n      columnNumber: 19\n    }\n  }, token))))), fromToken && /*#__PURE__*/React.createElement(Row, {\n    style: {\n      marginBottom: 8\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 128,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Col, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 129,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(Select, {\n    style: {\n      minWidth: 300\n    },\n    value: toToken,\n    onChange: setMarket,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 130,\n      columnNumber: 17\n    }\n  }, [...(tokenConvertMap.get(fromToken) || [])].map(token => /*#__PURE__*/React.createElement(Option, {\n    value: token,\n    key: token,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 136,\n      columnNumber: 21\n    }\n  }, token))))), fromToken && toToken && /*#__PURE__*/React.createElement(MarketProvider, {\n    marketAddress: marketAddress,\n    setMarketAddress: setMarketAddress,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 145,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(ConvertFormSubmit, {\n    size: size,\n    setSize: setSize,\n    fromToken: fromToken,\n    toToken: toToken,\n    wallet: wallet,\n    customMarkets: customMarkets,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 149,\n      columnNumber: 15\n    }\n  }))));\n}\n\nfunction ConvertFormSubmit({\n  size,\n  setSize,\n  fromToken,\n  toToken,\n  wallet,\n  customMarkets\n}) {\n  const {\n    market\n  } = useMarket();\n  const [accounts] = useTokenAccounts();\n  const balances = useBalances();\n  const [fromAmount, setFromAmount] = useState();\n  const [toAmount, setToAmount] = useState();\n  const {\n    storedFeeDiscountKey: feeDiscountKey\n  } = useLocallyStoredFeeDiscountKey();\n  const connection = useConnection();\n  const sendConnection = useSendConnection();\n  const [isConverting, setIsConverting] = useState(false);\n\n  const isFromTokenBaseOfMarket = market => {\n    const {\n      marketName\n    } = getMarketDetails(market, customMarkets);\n\n    if (!marketName) {\n      throw Error('Cannot determine if coin is quote or base because marketName is missing');\n    }\n\n    const [base] = marketName.split('/');\n    return fromToken === base;\n  };\n\n  const onConvert = async () => {\n    if (!market) {\n      console.warn('Market is null when attempting convert.');\n      notify({\n        message: 'Invalid market',\n        type: 'error'\n      });\n      return;\n    } // get accounts\n\n\n    const baseCurrencyAccount = getSelectedTokenAccountForMint(accounts, market === null || market === void 0 ? void 0 : market.baseMintAddress);\n    const quoteCurrencyAccount = getSelectedTokenAccountForMint(accounts, market === null || market === void 0 ? void 0 : market.quoteMintAddress); // get approximate price\n\n    let side;\n\n    try {\n      side = isFromTokenBaseOfMarket(market) ? 'sell' : 'buy';\n    } catch (e) {\n      console.warn(e);\n      notify({\n        message: 'Error placing order',\n        description: e.message,\n        type: 'error'\n      });\n      return;\n    }\n\n    const sidedOrderbookAccount = // @ts-ignore\n    side === 'buy' ? market._decoded.asks : market._decoded.bids;\n    const orderbookData = await connection.getAccountInfo(sidedOrderbookAccount);\n\n    if (!(orderbookData === null || orderbookData === void 0 ? void 0 : orderbookData.data)) {\n      notify({\n        message: 'Invalid orderbook data',\n        type: 'error'\n      });\n      return;\n    }\n\n    const decodedOrderbookData = Orderbook.decode(market, orderbookData.data);\n    const [bbo] = decodedOrderbookData && decodedOrderbookData.getL2(1).map(([price]) => price);\n\n    if (!bbo) {\n      notify({\n        message: 'No best price found',\n        type: 'error'\n      });\n      return;\n    }\n\n    if (!size) {\n      notify({\n        message: 'Size not specified',\n        type: 'error'\n      });\n      return;\n    }\n\n    const tickSizeDecimals = getDecimalCount(market.tickSize);\n    const parsedPrice = getMarketOrderPrice(decodedOrderbookData, size, tickSizeDecimals); // round size\n\n    const sizeDecimalCount = getDecimalCount(market.minOrderSize);\n    const nativeSize = side === 'sell' ? size : size / parsedPrice;\n    const parsedSize = floorToDecimal(nativeSize, sizeDecimalCount);\n    setIsConverting(true);\n\n    try {\n      if (!wallet) {\n        return null;\n      }\n\n      await placeOrder({\n        side,\n        price: parsedPrice,\n        size: parsedSize,\n        orderType: 'ioc',\n        market,\n        connection: sendConnection,\n        wallet,\n        baseCurrencyAccount: baseCurrencyAccount === null || baseCurrencyAccount === void 0 ? void 0 : baseCurrencyAccount.pubkey,\n        quoteCurrencyAccount: quoteCurrencyAccount === null || quoteCurrencyAccount === void 0 ? void 0 : quoteCurrencyAccount.pubkey,\n        feeDiscountPubkey: feeDiscountKey\n      });\n    } catch (e) {\n      console.warn(e);\n      notify({\n        message: 'Error placing order',\n        description: e.message,\n        type: 'error'\n      });\n    } finally {\n      setIsConverting(false);\n    }\n  };\n\n  const getPrice = async () => {\n    try {\n      const side = isFromTokenBaseOfMarket(market) ? 'sell' : 'buy';\n      const sidedOrderbookAccount = // @ts-ignore\n      side === 'buy' ? market._decoded.asks : market._decoded.bids;\n      const orderbookData = await connection.getAccountInfo(sidedOrderbookAccount);\n\n      if (!(orderbookData === null || orderbookData === void 0 ? void 0 : orderbookData.data) || !market) {\n        return [null, null];\n      }\n\n      const decodedOrderbookData = Orderbook.decode(market, orderbookData.data);\n      const [bbo] = decodedOrderbookData && decodedOrderbookData.getL2(1).map(([price]) => price);\n\n      if (!bbo || !size) {\n        return [null, null];\n      }\n\n      const tickSizeDecimals = getDecimalCount(market.tickSize);\n      const expectedPrice = getExpectedFillPrice(decodedOrderbookData, size, tickSizeDecimals);\n\n      if (side === 'buy') {\n        return [expectedPrice.toFixed(6), 1];\n      } else {\n        return [1, expectedPrice.toFixed(6)];\n      }\n    } catch (e) {\n      console.log(`Got error ${e}`);\n      return [null, null];\n    }\n  };\n\n  useEffect(() => {\n    getPrice().then(([fromAmount, toAmount]) => {\n      setFromAmount(fromAmount || undefined);\n      setToAmount(toAmount || undefined);\n    });\n  }, // eslint-disable-next-line\n  [market === null || market === void 0 ? void 0 : market.address.toBase58(), size]);\n  const canConvert = market && size && size > 0;\n  const balance = balances.find(coinBalance => coinBalance.coin === fromToken);\n  const availableBalance = (((balance === null || balance === void 0 ? void 0 : balance.unsettled) || 0) + ((balance === null || balance === void 0 ? void 0 : balance.wallet) || 0)) * 0.99;\n  return /*#__PURE__*/React.createElement(React.Fragment, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 356,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Row, {\n    style: {\n      marginBottom: 8\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 357,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Col, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 358,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Input, {\n    style: {\n      minWidth: 300\n    },\n    addonBefore: `Size (${fromToken})`,\n    placeholder: \"Size\",\n    value: size === null ? undefined : size,\n    type: \"number\",\n    onChange: e => setSize(parseFloat(e.target.value) || undefined),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 359,\n      columnNumber: 11\n    }\n  }))), /*#__PURE__*/React.createElement(Row, {\n    gutter: 12,\n    style: {\n      marginBottom: 8\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 369,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Col, {\n    span: 12,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 370,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(ActionButton, {\n    block: true,\n    size: \"large\",\n    onClick: () => setSize(floorToDecimal(availableBalance, 4)),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 371,\n      columnNumber: 11\n    }\n  }, \"Max: \", availableBalance.toFixed(4))), /*#__PURE__*/React.createElement(Col, {\n    span: 12,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 379,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(ConvertButton, {\n    block: true,\n    type: \"primary\",\n    size: \"large\",\n    loading: isConverting,\n    onClick: onConvert,\n    disabled: !canConvert,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 380,\n      columnNumber: 11\n    }\n  }, \"Convert\"))), canConvert && /*#__PURE__*/React.createElement(Row, {\n    align: \"middle\",\n    justify: \"center\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 393,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Col, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 394,\n      columnNumber: 11\n    }\n  }, fromAmount, \" \", fromToken), /*#__PURE__*/React.createElement(Col, {\n    offset: 1,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 397,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(SwapOutlined, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 398,\n      columnNumber: 13\n    }\n  })), /*#__PURE__*/React.createElement(Col, {\n    offset: 1,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 400,\n      columnNumber: 11\n    }\n  }, toAmount, \" \", toToken)));\n}","map":{"version":3,"sources":["/home/dev/Code/dex-ui/src/components/ConvertForm.tsx"],"names":["React","useEffect","useState","Button","Col","Input","Row","Select","Typography","styled","Orderbook","getExpectedFillPrice","getMarketDetails","getMarketInfos","getMarketOrderPrice","getSelectedTokenAccountForMint","MarketProvider","useBalances","useCustomMarkets","useLocallyStoredFeeDiscountKey","useMarket","useTokenAccounts","notify","useWallet","useConnection","useSendConnection","placeOrder","floorToDecimal","getDecimalCount","FloatingElement","WalletConnect","SwapOutlined","Option","Title","ActionButton","ConvertButton","ConvertForm","connected","wallet","customMarkets","marketInfos","marketAddress","setMarketAddress","fromToken","setFromToken","undefined","toToken","setToToken","size","setSize","marketInfosbyName","Object","fromEntries","map","market","name","tokenConvertMap","Map","keys","forEach","base","quote","split","has","set","Set","get","setMarket","marketInfo","filter","deprecated","find","console","warn","message","type","address","toBase58","maxWidth","marginBottom","minWidth","token","Array","from","ConvertFormSubmit","accounts","balances","fromAmount","setFromAmount","toAmount","setToAmount","storedFeeDiscountKey","feeDiscountKey","connection","sendConnection","isConverting","setIsConverting","isFromTokenBaseOfMarket","marketName","Error","onConvert","baseCurrencyAccount","baseMintAddress","quoteCurrencyAccount","quoteMintAddress","side","e","description","sidedOrderbookAccount","_decoded","asks","bids","orderbookData","getAccountInfo","data","decodedOrderbookData","decode","bbo","getL2","price","tickSizeDecimals","tickSize","parsedPrice","sizeDecimalCount","minOrderSize","nativeSize","parsedSize","orderType","pubkey","feeDiscountPubkey","getPrice","expectedPrice","toFixed","log","then","canConvert","balance","coinBalance","coin","availableBalance","unsettled","parseFloat","target","value"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react';\r\nimport { Button, Col, Input, Row, Select, Typography } from 'antd';\r\nimport styled from 'styled-components';\r\nimport { Orderbook } from '@project-serum/serum';\r\nimport {\r\n  getExpectedFillPrice,\r\n  getMarketDetails,\r\n  getMarketInfos,\r\n  getMarketOrderPrice,\r\n  getSelectedTokenAccountForMint,\r\n  MarketProvider,\r\n  useBalances,\r\n  useCustomMarkets, useLocallyStoredFeeDiscountKey,\r\n  useMarket,\r\n  useTokenAccounts,\r\n} from '../utils/markets';\r\nimport { notify } from '../utils/notifications';\r\nimport { useWallet } from '../utils/wallet';\r\nimport { useConnection, useSendConnection } from '../utils/connection';\r\nimport { placeOrder } from '../utils/send';\r\nimport { floorToDecimal, getDecimalCount } from '../utils/utils';\r\nimport FloatingElement from './layout/FloatingElement';\r\nimport WalletConnect from './WalletConnect';\r\nimport { SwapOutlined } from '@ant-design/icons';\r\nimport { CustomMarketInfo } from '../utils/types';\r\n// import Wallet from '@project-serum/sol-wallet-adapter';\r\nimport { WalletAdapter } from '../wallet-adapters';\r\n\r\nconst { Option } = Select;\r\nconst { Title } = Typography;\r\n\r\nconst ActionButton = styled(Button)`\r\n  color: #2abdd2;\r\n  background-color: #212734;\r\n  border-width: 0px;\r\n`;\r\n\r\nconst ConvertButton = styled(Button)`\r\n  background: #02bf76;\r\n  border-color: #02bf76;\r\n`;\r\n\r\nexport default function ConvertForm() {\r\n  const { connected, wallet } = useWallet(); \r\n  const { customMarkets } = useCustomMarkets();\r\n  const marketInfos = getMarketInfos(customMarkets);\r\n  const [marketAddress, setMarketAddress] = useState<string | null>(null);\r\n\r\n  const [fromToken, setFromToken] = useState<string | undefined>(undefined);\r\n  const [toToken, setToToken] = useState<string | undefined>(undefined);\r\n  const [size, setSize] = useState<number | undefined>(undefined);\r\n\r\n  const marketInfosbyName = Object.fromEntries(\r\n    marketInfos.map((market) => [market.name, market]),\r\n  );\r\n\r\n  const tokenConvertMap: Map<string, Set<string>> = new Map();\r\n  Object.keys(marketInfosbyName).forEach((market) => {\r\n    let [base, quote] = market.split('/');\r\n    !tokenConvertMap.has(base)\r\n      ? tokenConvertMap.set(base, new Set([quote]))\r\n      : tokenConvertMap.set(\r\n          base,\r\n          new Set([...(tokenConvertMap.get(base) || []), quote]),\r\n        );\r\n    !tokenConvertMap.has(quote)\r\n      ? tokenConvertMap.set(quote, new Set([base]))\r\n      : tokenConvertMap.set(\r\n          quote,\r\n          new Set([...(tokenConvertMap.get(quote) || []), base]),\r\n        );\r\n  });\r\n\r\n  const setMarket = (toToken) => {\r\n    const marketInfo = marketInfos\r\n      .filter((marketInfo) => !marketInfo.deprecated)\r\n      .find(\r\n        (marketInfo) =>\r\n          marketInfo.name === `${fromToken}/${toToken}` ||\r\n          marketInfo.name === `${toToken}/${fromToken}`,\r\n      );\r\n    if (!marketInfo) {\r\n      console.warn(\r\n        `Could not find market info for market names ${fromToken}/${toToken} or ${toToken}/${fromToken}`,\r\n      );\r\n      notify({\r\n        message: 'Invalid market',\r\n        type: 'error',\r\n      });\r\n      return;\r\n    }\r\n    setMarketAddress(marketInfo.address.toBase58());\r\n    setToToken(toToken);\r\n  };\r\n\r\n  return (\r\n    <FloatingElement style={{ maxWidth: 500 }}>\r\n      <Title level={3}>Convert</Title>\r\n      {!connected && (\r\n        <Row justify=\"center\">\r\n          <Col>\r\n            <WalletConnect />\r\n          </Col>\r\n        </Row>\r\n      )}\r\n      {tokenConvertMap && connected && (\r\n        <>\r\n          <Row style={{ marginBottom: 8 }}>\r\n            <Col>\r\n              <Select\r\n                style={{ minWidth: 300 }}\r\n                placeholder=\"Select a token\"\r\n                value={fromToken}\r\n                onChange={(token) => {\r\n                  setFromToken(token);\r\n                  setToToken(undefined);\r\n                }}\r\n              >\r\n                {Array.from(tokenConvertMap.keys()).map((token) => (\r\n                  <Option value={token} key={token}>\r\n                    {token}\r\n                  </Option>\r\n                ))}\r\n              </Select>\r\n            </Col>\r\n          </Row>\r\n          {fromToken && (\r\n            <Row style={{ marginBottom: 8 }}>\r\n              <Col>\r\n                <Select\r\n                  style={{ minWidth: 300 }}\r\n                  value={toToken}\r\n                  onChange={setMarket}\r\n                >\r\n                  {[...(tokenConvertMap.get(fromToken) || [])].map((token) => (\r\n                    <Option value={token} key={token}>\r\n                      {token}\r\n                    </Option>\r\n                  ))}\r\n                </Select>\r\n              </Col>\r\n            </Row>\r\n          )}\r\n          {fromToken && toToken && (\r\n            <MarketProvider\r\n              marketAddress={marketAddress}\r\n              setMarketAddress={setMarketAddress}\r\n            >\r\n              <ConvertFormSubmit\r\n                size={size}\r\n                setSize={setSize}\r\n                fromToken={fromToken}\r\n                toToken={toToken}\r\n                wallet={wallet}\r\n                customMarkets={customMarkets}\r\n              />\r\n            </MarketProvider>\r\n          )}\r\n        </>\r\n      )}\r\n    </FloatingElement>\r\n  );\r\n}\r\n\r\nfunction ConvertFormSubmit({\r\n  size,\r\n  setSize,\r\n  fromToken,\r\n  toToken,\r\n  wallet,\r\n  customMarkets,\r\n}: {\r\n  size: number | null | undefined;\r\n  setSize: (newSize: number | undefined) => void;\r\n  fromToken: string;\r\n  toToken: string;\r\n  wallet?: WalletAdapter;\r\n  customMarkets: CustomMarketInfo[];\r\n}) {\r\n  const { market } = useMarket();\r\n  const [accounts] = useTokenAccounts();\r\n  const balances = useBalances();\r\n  const [fromAmount, setFromAmount] = useState<number | undefined>();\r\n  const [toAmount, setToAmount] = useState<number | undefined>();\r\n  const { storedFeeDiscountKey: feeDiscountKey } = useLocallyStoredFeeDiscountKey();\r\n\r\n  const connection = useConnection();\r\n  const sendConnection = useSendConnection();\r\n\r\n  const [isConverting, setIsConverting] = useState(false);\r\n\r\n  const isFromTokenBaseOfMarket = (market) => {\r\n    const { marketName } = getMarketDetails(market, customMarkets);\r\n    if (!marketName) {\r\n      throw Error(\r\n        'Cannot determine if coin is quote or base because marketName is missing',\r\n      );\r\n    }\r\n    const [base] = marketName.split('/');\r\n    return fromToken === base;\r\n  };\r\n\r\n  const onConvert = async () => {\r\n    if (!market) {\r\n      console.warn('Market is null when attempting convert.');\r\n      notify({\r\n        message: 'Invalid market',\r\n        type: 'error',\r\n      });\r\n      return;\r\n    }\r\n    // get accounts\r\n    const baseCurrencyAccount = getSelectedTokenAccountForMint(\r\n      accounts,\r\n      market?.baseMintAddress,\r\n    );\r\n    const quoteCurrencyAccount = getSelectedTokenAccountForMint(\r\n      accounts,\r\n      market?.quoteMintAddress,\r\n    );\r\n\r\n    // get approximate price\r\n    let side;\r\n    try {\r\n      side = isFromTokenBaseOfMarket(market) ? 'sell' : 'buy';\r\n    } catch (e) {\r\n      console.warn(e);\r\n      notify({\r\n        message: 'Error placing order',\r\n        description: e.message,\r\n        type: 'error',\r\n      });\r\n      return;\r\n    }\r\n\r\n    const sidedOrderbookAccount =\r\n      // @ts-ignore\r\n      side === 'buy' ? market._decoded.asks : market._decoded.bids;\r\n    const orderbookData = await connection.getAccountInfo(\r\n      sidedOrderbookAccount,\r\n    );\r\n    if (!orderbookData?.data) {\r\n      notify({ message: 'Invalid orderbook data', type: 'error' });\r\n      return;\r\n    }\r\n    const decodedOrderbookData = Orderbook.decode(market, orderbookData.data);\r\n    const [bbo] =\r\n      decodedOrderbookData &&\r\n      decodedOrderbookData.getL2(1).map(([price]) => price);\r\n    if (!bbo) {\r\n      notify({ message: 'No best price found', type: 'error' });\r\n      return;\r\n    }\r\n    if (!size) {\r\n      notify({ message: 'Size not specified', type: 'error' });\r\n      return;\r\n    }\r\n\r\n    const tickSizeDecimals = getDecimalCount(market.tickSize);\r\n    const parsedPrice = getMarketOrderPrice(\r\n      decodedOrderbookData,\r\n      size,\r\n      tickSizeDecimals,\r\n    );\r\n\r\n    // round size\r\n    const sizeDecimalCount = getDecimalCount(market.minOrderSize);\r\n    const nativeSize = side === 'sell' ? size : size / parsedPrice;\r\n    const parsedSize = floorToDecimal(nativeSize, sizeDecimalCount);\r\n\r\n    setIsConverting(true);\r\n    try {\r\n      if (!wallet) {\r\n        return null;\r\n      }\r\n\r\n      await placeOrder({\r\n        side,\r\n        price: parsedPrice,\r\n        size: parsedSize,\r\n        orderType: 'ioc',\r\n        market,\r\n        connection: sendConnection,\r\n        wallet,\r\n        baseCurrencyAccount: baseCurrencyAccount?.pubkey,\r\n        quoteCurrencyAccount: quoteCurrencyAccount?.pubkey,\r\n        feeDiscountPubkey: feeDiscountKey,\r\n      });\r\n    } catch (e) {\r\n      console.warn(e);\r\n      notify({\r\n        message: 'Error placing order',\r\n        description: e.message,\r\n        type: 'error',\r\n      });\r\n    } finally {\r\n      setIsConverting(false);\r\n    }\r\n  };\r\n\r\n  const getPrice = async () => {\r\n    try {\r\n      const side = isFromTokenBaseOfMarket(market) ? 'sell' : 'buy';\r\n      const sidedOrderbookAccount =\r\n        // @ts-ignore\r\n        side === 'buy' ? market._decoded.asks : market._decoded.bids;\r\n      const orderbookData = await connection.getAccountInfo(\r\n        sidedOrderbookAccount,\r\n      );\r\n      if (!orderbookData?.data || !market) {\r\n        return [null, null];\r\n      }\r\n      const decodedOrderbookData = Orderbook.decode(market, orderbookData.data);\r\n      const [bbo] =\r\n        decodedOrderbookData &&\r\n        decodedOrderbookData.getL2(1).map(([price]) => price);\r\n      if (!bbo || !size) {\r\n        return [null, null];\r\n      }\r\n      const tickSizeDecimals = getDecimalCount(market.tickSize);\r\n      const expectedPrice = getExpectedFillPrice(\r\n        decodedOrderbookData,\r\n        size,\r\n        tickSizeDecimals,\r\n      );\r\n      if (side === 'buy') {\r\n        return [expectedPrice.toFixed(6), 1];\r\n      } else {\r\n        return [1, expectedPrice.toFixed(6)];\r\n      }\r\n    } catch (e) {\r\n      console.log(`Got error ${e}`);\r\n      return [null, null];\r\n    }\r\n  };\r\n\r\n  useEffect(\r\n    () => {\r\n      getPrice().then(([fromAmount, toAmount]) => {\r\n        setFromAmount(fromAmount || undefined);\r\n        setToAmount(toAmount || undefined);\r\n      });\r\n    },\r\n    // eslint-disable-next-line\r\n    [market?.address.toBase58(), size],\r\n  );\r\n\r\n  const canConvert = market && size && size > 0;\r\n  const balance = balances.find(\r\n    (coinBalance) => coinBalance.coin === fromToken,\r\n  );\r\n  const availableBalance =\r\n    ((balance?.unsettled || 0) + (balance?.wallet || 0)) * 0.99;\r\n\r\n  return (\r\n    <React.Fragment>\r\n      <Row style={{ marginBottom: 8 }}>\r\n        <Col>\r\n          <Input\r\n            style={{ minWidth: 300 }}\r\n            addonBefore={`Size (${fromToken})`}\r\n            placeholder=\"Size\"\r\n            value={size === null ? undefined : size}\r\n            type=\"number\"\r\n            onChange={(e) => setSize(parseFloat(e.target.value) || undefined)}\r\n          />\r\n        </Col>\r\n      </Row>\r\n      <Row gutter={12} style={{ marginBottom: 8 }}>\r\n        <Col span={12}>\r\n          <ActionButton\r\n            block\r\n            size=\"large\"\r\n            onClick={() => setSize(floorToDecimal(availableBalance, 4))}\r\n          >\r\n            Max: {availableBalance.toFixed(4)}\r\n          </ActionButton>\r\n        </Col>\r\n        <Col span={12}>\r\n          <ConvertButton\r\n            block\r\n            type=\"primary\"\r\n            size=\"large\"\r\n            loading={isConverting}\r\n            onClick={onConvert}\r\n            disabled={!canConvert}\r\n          >\r\n            Convert\r\n          </ConvertButton>\r\n        </Col>\r\n      </Row>\r\n      {canConvert && (\r\n        <Row align=\"middle\" justify=\"center\">\r\n          <Col>\r\n            {fromAmount} {fromToken}\r\n          </Col>\r\n          <Col offset={1}>\r\n            <SwapOutlined />\r\n          </Col>\r\n          <Col offset={1}>\r\n            {toAmount} {toToken}\r\n          </Col>\r\n        </Row>\r\n      )}\r\n    </React.Fragment>\r\n  );\r\n}\r\n"]},"metadata":{},"sourceType":"module"}